import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,e as t,o as n}from"./app-Dvgq7Lzg.js";const e={};function l(h,i){return n(),a("div",null,[...i[0]||(i[0]=[t(`<div class="language-js line-numbers-mode" data-highlighter="shiki" data-ext="js" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-js"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">navigator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">geolocation</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">       navigator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">geolocation</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getCurrentPosition</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">function</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">position</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">            console</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">position</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">coords</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">latitude</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">            console</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">position</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">coords</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">longitude</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          }, (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">            console</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">error</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">e</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          });</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    else</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">        console</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;该浏览器不支持获取地理位置。&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>调试环境</strong>：手机端safari，Android 自带浏览器， PC---chrome edge Firefox</p><ul><li><h3 id="在本地开发时" tabindex="-1"><a class="header-anchor" href="#在本地开发时"><span>在本地开发时</span></a></h3></li></ul><p>使用localhost访问正常获取，使用本地ip获取失败</p><table><thead><tr><th>客户端</th><th>效果</th></tr></thead><tbody><tr><td>safari</td><td>origin does not have permission to use geolocation service</td></tr><tr><td>Android</td><td>*<em><em>GeolocationPositionError</em> <em>{code: 1, message: &#39;Only secure origins are allowed (see: <a href="https://goo.gl/Y0ZkNV" target="_blank" rel="noopener noreferrer">https://goo.gl/Y0ZkNV</a>).&#39;}</em></em></td></tr><tr><td>Chrome</td><td>*<em><em>GeolocationPositionError</em> <em>{code: 1, message: &#39;Only secure origins are allowed (see: <a href="https://goo.gl/Y0ZkNV" target="_blank" rel="noopener noreferrer">https://goo.gl/Y0ZkNV</a>).&#39;}</em></em></td></tr></tbody></table><p>本地调试只能使用localhost访问正常获取</p><p>“只有在安全来源的情况才才被允许”。错误信息里还包含了一个提示链接，我们不妨打开这个链接（<a href="https://link.segmentfault.com/?enc=JkcbTDCTz4qt72ckkXjPFA%3D%3D.PfW2Msuen%2Ft%2FTDf1At7yYQ%2BEvJRTdy4lD1gkfY4k5%2Bs%3D" target="_blank" rel="noopener noreferrer">https://goo.gl/Y0ZkNV</a>）看看。原来，为了保障用户的安全，Chrome浏览器认为只有安全的来源才能开启定位服务。那什么样才算是安全的来源呢？在打开链接的页面上有这么一段话：</p><blockquote><p>“Secure origins” are origins that match at least one of the following (scheme, host, port) patterns:</p><ul><li>(https, *, *)</li><li>(wss, *, *)</li><li>(*, localhost, *)</li><li>(*, 127/8, *)</li><li>(*, ::1/128, *)</li><li>(file, *, —)</li><li>(chrome-extension, *, —)</li></ul><p>This list may be incomplete, and may need to be changed. Please discuss!</p></blockquote><p>大概意思是说只有包含上述列表中的<code>scheme</code>、<code>host</code>或者<code>port</code>才会被认为是安全的来源，现在这个列表还不够完整，后续可能还会有变动，有待讨论。</p><ul><li><h3 id="部署到https的域名下" tabindex="-1"><a class="header-anchor" href="#部署到https的域名下"><span>部署到HTTPS的域名下</span></a></h3></li></ul><p>在页面挂载后调用API获取经纬度，无任何交互手势</p><table><thead><tr><th>客户端</th><th>效果</th></tr></thead><tbody><tr><td>Edge</td><td>正常</td></tr><tr><td>chrome</td><td>[Violation] Only request geolocation information in response to a user gesture.</td></tr><tr><td>iphone--safari</td><td>user denied geolocation</td></tr><tr><td>Android</td><td>正常</td></tr></tbody></table><ol><li>发起定位请求需要用户的手势来发起</li><li>safari 缺少用户授权 。 在iOS，重置定位权限的操作路径是：系统-通用-还原-还原位置和隐私。</li></ol><p>扩展：Google 似乎 <a href="https://link.segmentfault.com/?enc=G9nnohnAyMrkLKQ9U4Wn8A%3D%3D.zkEujwJTSHIYyIOxJp4PPNJvHhuHamaKLQ6oQXMB%2BqJtx3kS%2FTbEaiQnZX%2BtAHEhM9Ef%2F88Qe0HOSZy8%2BTyknsmWYFt54qaQ2DuQ9UK2fx4%3D" target="_blank" rel="noopener noreferrer">建议</a> <strong>不要</strong> 在页面加载时加载地理位置：</p><blockquote><p>用户对在页面加载时自动请求其位置的页面不信任或感到困惑。不是在页面加载时自动请求用户的位置，而是将请求与用户的手势联系起来，例如点击“查找靠近我的商店”按钮。确保手势清楚明确地表达了对用户位置的需要。</p></blockquote><ul><li><h3 id="修改代码后由用户手势获取" tabindex="-1"><a class="header-anchor" href="#修改代码后由用户手势获取"><span>修改代码后由用户手势获取</span></a></h3></li></ul><table><thead><tr><th>客户端</th><th>效果</th></tr></thead><tbody><tr><td>Edge</td><td>正常</td></tr><tr><td>chrome</td><td>Network location provider at &#39;<a href="https://www.googleapis.com/" target="_blank" rel="noopener noreferrer">https://www.googleapis.com/</a>&#39; : ERR_CONNECTION_TIMED_OUT.</td></tr><tr><td>safari</td><td>正常</td></tr><tr><td>Android</td><td>正常</td></tr><tr><td>Firefox</td><td>unknown error acquiring position</td></tr></tbody></table><ol><li>Chrome、Firefox以及一些套壳浏览器接入的定位服务在国外，有较大的限制，也会造成定位失败，且失败率较高。</li></ol><p>总结：使用H5的 geolocation api需要满足</p><ul><li><p>用户授权位置信息</p></li><li><p>用户主动交互手势</p></li><li><p>HTTPS协议</p></li><li><p>在网站中说明隐私政策，告诉用户位置信息的用途</p></li></ul><p><strong>常见错误原因</strong></p><ol><li>用户未授权 Geolocation permission denied</li><li>浏览器不支持定位接口 Browser not Support html5 geolocation</li><li>非HTTPS安全访问 Only secure origins are allowed</li><li>定位时间超时</li><li>chrome和Firefox 可能被墙</li></ol><p><strong>其他</strong>：定位经纬时，同一位置edge和 移动端实际获取的经纬差异大。实际使用准确未知。</p><p>可根据具体场景决定是否使用H5的API，在移动端还有小程序的API</p><p><strong>参考资料：</strong></p><p><a href="https://segmentfault.com/a/1190000009249162" target="_blank" rel="noopener noreferrer">使用HTML5地理位置定位到城市的方法及注意事项</a></p><p><a href="https://www.jianshu.com/p/84e732db6acc" target="_blank" rel="noopener noreferrer">HTML5定位的使用，及定位失败的原因</a></p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Geolocation" target="_blank" rel="noopener noreferrer">MDN-Geolocation</a></p><p><strong>扩展：</strong> <a href="https://juejin.cn/post/7046595451876802596#heading-10" target="_blank" rel="noopener noreferrer">【前端探索】H5获取用户定位？看这一篇就够了</a></p>`,29)])])}const k=s(e,[["render",l]]),o=JSON.parse('{"path":"/posts/GeolocationAPI.html","title":"H5 Geolocation API 遇到的坑及总结","lang":"zh-CN","frontmatter":{"title":"H5 Geolocation API 遇到的坑及总结","description":"记录一次开发过程中使用  Geolocation API的时候，遇到的问题","date":"2024-06-20T00:00:00.000Z","lastUpdated":false,"tags":["Web"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"H5 Geolocation API 遇到的坑及总结\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-06-20T00:00:00.000Z\\",\\"dateModified\\":\\"2025-11-01T08:12:15.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Garlen\\",\\"url\\":\\"https://garlen20o.github.io/blog/\\"}]}"],["meta",{"property":"og:url","content":"https://garlen20o.github.io/blog/posts/GeolocationAPI.html"}],["meta",{"property":"og:site_name","content":"Garlen"}],["meta",{"property":"og:title","content":"H5 Geolocation API 遇到的坑及总结"}],["meta",{"property":"og:description","content":"记录一次开发过程中使用  Geolocation API的时候，遇到的问题"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-11-01T08:12:15.000Z"}],["meta",{"property":"article:tag","content":"Web"}],["meta",{"property":"article:published_time","content":"2024-06-20T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-11-01T08:12:15.000Z"}]]},"git":{"createdTime":1761984735000,"updatedTime":1761984735000,"contributors":[{"name":"Garlen","username":"Garlen","email":"649975243@qq.com","commits":1,"url":"https://github.com/Garlen"}]},"readingTime":{"minutes":3.12,"words":935},"filePathRelative":"posts/GeolocationAPI.md","excerpt":"<div class=\\"language-js line-numbers-mode\\" data-highlighter=\\"shiki\\" data-ext=\\"js\\" style=\\"--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34\\"><pre class=\\"shiki shiki-themes one-light one-dark-pro vp-code\\"><code class=\\"language-js\\"><span class=\\"line\\"><span style=\\"--shiki-light:#A626A4;--shiki-dark:#C678DD\\"> if</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\"> (</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#E5C07B\\">navigator</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">.</span><span style=\\"--shiki-light:#E45649;--shiki-dark:#E06C75\\">geolocation</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">)</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#E5C07B\\">       navigator</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">.</span><span style=\\"--shiki-light:#E45649;--shiki-dark:#E5C07B\\">geolocation</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">.</span><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">getCurrentPosition</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">(</span><span style=\\"--shiki-light:#A626A4;--shiki-dark:#C678DD\\">function</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">(</span><span style=\\"--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic\\">position</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">) {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#E5C07B\\">            console</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">.</span><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">log</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">(</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#E5C07B\\">position</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">.</span><span style=\\"--shiki-light:#E45649;--shiki-dark:#E5C07B\\">coords</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">.</span><span style=\\"--shiki-light:#E45649;--shiki-dark:#E06C75\\">latitude</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">);</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#E5C07B\\">            console</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">.</span><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">log</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">(</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#E5C07B\\">position</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">.</span><span style=\\"--shiki-light:#E45649;--shiki-dark:#E5C07B\\">coords</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">.</span><span style=\\"--shiki-light:#E45649;--shiki-dark:#E06C75\\">longitude</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">);</span></span>\\n<span class=\\"line\\"></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">          }, (</span><span style=\\"--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic\\">e</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">)</span><span style=\\"--shiki-light:#A626A4;--shiki-dark:#C678DD\\">=&gt;</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">{</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#E5C07B\\">            console</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">.</span><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">error</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">(</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#E06C75\\">e</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">);</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">          });</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    }</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#A626A4;--shiki-dark:#C678DD\\">    else</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    {</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#E5C07B\\">        console</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">.</span><span style=\\"--shiki-light:#4078F2;--shiki-dark:#61AFEF\\">log</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">(</span><span style=\\"--shiki-light:#50A14F;--shiki-dark:#98C379\\">\\"该浏览器不支持获取地理位置。\\"</span><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">);</span></span>\\n<span class=\\"line\\"><span style=\\"--shiki-light:#383A42;--shiki-dark:#ABB2BF\\">    }</span></span></code></pre>\\n<div class=\\"line-numbers\\" aria-hidden=\\"true\\" style=\\"counter-reset:line-number 0\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>"}');export{k as comp,o as data};
